var V=Object.defineProperty;var Y=(i,e,t)=>e in i?V(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var d=(i,e,t)=>Y(i,typeof e!="symbol"?e+"":e,t);import{S as X,h as K,i as Z,j as H,k as j,r as Q,F as _,P as O,l as v,V as g,m as L,n as T,C as ee,o as m,p as h,q as te,L as ie,R as oe,T as se,s as k,t as ae}from"./iframe-Dz-RJkZX.js";class I extends X{constructor(e,t,o){super(),o!==void 0&&t===void 0?this.setFlatCoordinates(o,e):(t=t||0,this.setCenterAndRadius(e,t,o))}clone(){const e=new I(this.flatCoordinates.slice(),void 0,this.layout);return e.applyProperties(this),e}closestPointXY(e,t,o,s){const a=this.flatCoordinates,l=e-a[0],c=t-a[1],n=l*l+c*c;if(n<s){if(n===0)for(let p=0;p<this.stride;++p)o[p]=a[p];else{const p=this.getRadius()/Math.sqrt(n);o[0]=a[0]+p*l,o[1]=a[1]+p*c;for(let r=2;r<this.stride;++r)o[r]=a[r]}return o.length=this.stride,n}return s}containsXY(e,t){const o=this.flatCoordinates,s=e-o[0],a=t-o[1];return s*s+a*a<=this.getRadiusSquared_()}getCenter(){return this.flatCoordinates.slice(0,this.stride)}computeExtent(e){const t=this.flatCoordinates,o=t[this.stride]-t[0];return K(t[0]-o,t[1]-o,t[0]+o,t[1]+o,e)}getRadius(){return Math.sqrt(this.getRadiusSquared_())}getRadiusSquared_(){const e=this.flatCoordinates[this.stride]-this.flatCoordinates[0],t=this.flatCoordinates[this.stride+1]-this.flatCoordinates[1];return e*e+t*t}getType(){return"Circle"}intersectsExtent(e){const t=this.getExtent();if(Z(e,t)){const o=this.getCenter();return e[0]<=o[0]&&e[2]>=o[0]||e[1]<=o[1]&&e[3]>=o[1]?!0:H(e,this.intersectsCoordinate.bind(this))}return!1}setCenter(e){const t=this.stride,o=this.flatCoordinates[t]-this.flatCoordinates[0],s=e.slice();s[t]=s[0]+o;for(let a=1;a<t;++a)s[t+a]=e[a];this.setFlatCoordinates(this.layout,s),this.changed()}setCenterAndRadius(e,t,o){this.setLayout(o,e,0),this.flatCoordinates||(this.flatCoordinates=[]);const s=this.flatCoordinates;let a=j(s,0,e,this.stride);s[a++]=s[0]+t;for(let l=1,c=this.stride;l<c;++l)s[a++]=s[l];s.length=a,this.changed()}getCoordinates(){return null}setCoordinates(e,t){}setRadius(e){this.flatCoordinates[this.stride]=this.flatCoordinates[0]+e,this.changed()}rotate(e,t){const o=this.getCenter(),s=this.getStride();this.setCenter(Q(o,0,o.length,s,e,t,o)),this.changed()}}const ne=i=>new _({geometry:new O(v([i.longitude,i.latitude])),...i}),N=i=>i.map(ne),re=6,le="#d4351c",ce="#505a5f",de=2,pe=!0;class ye extends g{constructor({positions:e,style:t={},title:o,visible:s=pe,zIndex:a}){const l=t.radius??re,c=t.fill??le,n=t.stroke??{},p=n.color??ce,r=n.width??de;super({properties:{title:o},source:new T({features:N(e)}),style:new L({image:new ee({radius:l,fill:new h({color:c}),stroke:new m({color:p,width:r,lineCap:n.lineCap,lineJoin:n.lineJoin,lineDash:n.lineDash,lineDashOffset:n.lineDashOffset,miterLimit:n.miterLimit}),displacement:t.displacement,rotation:t.rotation,rotateWithView:t.rotateWithView,scale:t.scale})}),visible:s,zIndex:a})}}class ue{constructor(e){d(this,"id");d(this,"options");d(this,"olLayer");this.options=e,this.id=e.id??"locations"}getNativeLayer(){return this.olLayer}attach(e,t){if(e.mapLibrary!=="openlayers"){console.warn(`[LocationLayer] MapLibre support is not implemented yet (layer "${this.id}")`);return}const{map:o}=e.openlayers;this.olLayer=new ye({positions:this.options.positions??[],style:this.options.style,title:this.options.title??this.id,visible:t?.visible??this.options.visible,zIndex:t?.zIndex??this.options.zIndex}),o.addLayer(this.olLayer)}detach(e){if(e.mapLibrary==="openlayers"){this.olLayer&&(e.openlayers.map.removeLayer(this.olLayer),this.olLayer=void 0);return}console.warn(`[LocationLayer] MapLibre detach is not implemented yet (layer "${this.id}")`)}}const me=i=>new _({geometry:new I(v([i.longitude,i.latitude]),i.precision)}),he=i=>i.map(me),Le="rgba(255, 165, 0, 0.1)",fe="orange",ve=2,ge=!1;class Te extends g{constructor({positions:e,style:t,title:o,visible:s=ge,zIndex:a}){let l;t?.fill===null?l=void 0:l=t?.fill??Le;let c;if(t?.stroke===null)c=void 0;else{const n=t?.stroke;c={color:n?.color??fe,width:n?.width??ve,lineDash:n?.lineDash,lineCap:n?.lineCap,lineJoin:n?.lineJoin,lineDashOffset:n?.lineDashOffset,miterLimit:n?.miterLimit}}super({properties:{title:o},source:new T({features:he(e??[])}),style:new L({fill:l?new h({color:l}):void 0,stroke:c?new m({color:c.color,width:c.width,lineDash:c.lineDash,lineCap:c.lineCap,lineJoin:c.lineJoin,lineDashOffset:c.lineDashOffset,miterLimit:c.miterLimit}):void 0}),visible:s,zIndex:a})}}function be(i){return"precision"in i&&typeof i.precision=="number"}class Ce{constructor(e){d(this,"id");d(this,"options");d(this,"olLayer");this.options=e,this.id=e.id??"circles"}getNativeLayer(){return this.olLayer}attach(e){if(e.mapLibrary!=="openlayers"){console.warn(`[CirclesLayer] MapLibre support is not implemented yet (layer "${this.id}")`);return}const{map:t}=e.openlayers,s=(this.options.positions??[]).filter(be);this.olLayer=new Te({positions:s,style:this.options.style,title:this.options.title??this.id,visible:this.options.visible,zIndex:this.options.zIndex}),t.addLayer(this.olLayer)}detach(e){e.mapLibrary==="openlayers"&&this.olLayer&&(e.openlayers.map.removeLayer(this.olLayer),this.olLayer=void 0)}}const R=(i,e,t)=>Math.max(e,Math.min(t,i)),E=10,C=1.25,Se=.15,F=2,_e=i=>{const e=(F-C)/(Se-E),t=C-E*e;return R(e*i+t,C,F)};class Ie extends L{constructor(e,t){super({stroke:new m({width:_e(t),color:e})})}}const we=(i,e)=>new _({geometry:new ie([v([i.longitude,i.latitude]),v([e.longitude,e.latitude])])}),De=i=>new te(i.reduce((e,t,o)=>(o!==i.length-1&&e.push(we(t,i[o+1])),e),[])),Ae=(i,e)=>{const t=e[0]-i[0],o=e[1]-i[1];return Math.atan2(o,t)},ke=(i,e,t)=>{const o=e*Math.sin(t),s=e*Math.cos(t);return[i[0]+o,i[1]+s]},M=10,S=4,Ee=.15,x=6,Fe=i=>{const e=(x-S)/(Ee-M),t=S-M*e;return R(e*i+t,S,x)};class Me extends L{constructor(e,t,o){super({geometry:new O(e),image:new oe({points:3,radius:Fe(t),fill:new h({color:"black"}),rotation:o,rotateWithView:!0})})}}const xe=(i,e,t,o)=>{const a=50*o,l=Math.max(Math.floor(t/a),1),c=t/(l+1);return[...Array(l).keys()].map(n=>new Me(ke(i,c*(n+1),e),o,e))},Oe=i=>(e,t)=>{const o=e.getGeometry(),s=o.getCoordinates(),a=o.getLength(),l=s[0],c=s[1],n=-Ae(l,c)+Math.PI/2;return[new Ie(i.stroke.color,t),...xe(l,n,a,t)]},Ne=!1,Re="black",Ue={stroke:{color:Re}};class Pe extends g{constructor({positions:e,style:t=Ue,title:o,visible:s=Ne,zIndex:a}){super({properties:{title:o},source:new T({features:De(e)}),style:Oe(t),visible:s,zIndex:a})}}class Ge{constructor(e){d(this,"id");d(this,"options");d(this,"olLayer");this.options=e,this.id=e.id??"tracks"}getNativeLayer(){return this.olLayer}attach(e){if(e.mapLibrary!=="openlayers"){console.warn(`[TracksLayer] MapLibre support is not implemented yet (layer "${this.id}")`);return}const{map:t}=e.openlayers;this.olLayer=new Pe({positions:this.options.positions,style:this.options.style,title:this.options.title??this.id,visible:this.options.visible,zIndex:this.options.zIndex}),t.addLayer(this.olLayer)}detach(e){e.mapLibrary==="openlayers"&&this.olLayer&&(e.openlayers.map.removeLayer(this.olLayer),this.olLayer=void 0)}}const U='bold 14px "GDS Transport", system-ui, sans-serif',P="black",G="white",B=2,$=12,W=1,Be=!1,$e={fill:P,font:U,offset:{x:$,y:W},stroke:{color:G,width:B}},We=(i,e)=>t=>{const o=t.get(e);return o!==void 0?[new L({text:new se({text:String(o),font:i.font??U,fill:new h({color:i.fill??P}),stroke:new m({color:i.stroke?.color??G,width:i.stroke?.width??B}),offsetX:i.offset?.x??$,offsetY:i.offset?.y??W,textAlign:i.textAlign??"left",textBaseline:i.textBaseline??"middle",rotation:i.rotation,scale:i.scale,rotateWithView:i.rotateWithView,maxAngle:i.maxAngle,overflow:i.overflow,padding:i.padding,placement:i.placement,keepUpright:i.keepUpright,justify:i.justify,backgroundFill:i.backgroundFill?new h({color:i.backgroundFill}):void 0,backgroundStroke:i.backgroundStroke?new m({color:i.backgroundStroke.color,width:i.backgroundStroke.width,lineDash:i.backgroundStroke.lineDash}):void 0})})]:[]};class qe extends g{constructor({textProperty:e,positions:t,style:o=$e,title:s,visible:a=Be,zIndex:l}){super({properties:{title:s},source:new T({features:N(t)}),style:We(o,e),visible:a,zIndex:l})}}class ze{constructor(e){d(this,"id");d(this,"options");d(this,"olLayer");this.options=e,this.id=e.id??"text"}getNativeLayer(){return this.olLayer}attach(e){if(e.mapLibrary!=="openlayers"){console.warn(`[TextLayer] MapLibre support is not implemented yet (layer "${this.id}")`);return}const{map:t}=e.openlayers;this.olLayer=new qe({textProperty:this.options.textProperty,positions:this.options.positions,style:this.options.style,title:this.options.title??this.id,visible:this.options.visible,zIndex:this.options.zIndex}),t.addLayer(this.olLayer)}detach(e){e.mapLibrary==="openlayers"&&this.olLayer&&(e.openlayers.map.removeLayer(this.olLayer),this.olLayer=void 0)}}const Je=[{latitude:53.4808,longitude:-2.2426,precision:50,sequenceNumber:1,speed:5,direction:1.57,geolocationMechanism:"GPS",timestamp:"2025-01-01T12:00:00Z",overlayTitleTemplateId:"overlay-title-test-location",overlayBodyTemplateId:"overlay-body-test-location",personName:"Jane Doe",personNomisId:"A1234BC",displaySpeed:"5 km/h",displayDirection:"90°",displayGeolocationMechanism:"GPS",displayTimestamp:"2025-01-01 12:00:00",displayConfidence:"50m",displayLatitude:"53.4808",displayLongitude:"-2.2426"},{latitude:53.478,longitude:-2.25,precision:400,sequenceNumber:2,speed:15,direction:2.75,geolocationMechanism:"GPS",timestamp:"2025-01-01T12:10:00Z",overlayTitleTemplateId:"overlay-title-test-location",overlayBodyTemplateId:"overlay-body-test-location",personName:"Jane Doe",personNomisId:"A1234BC",displaySpeed:"15 km/h",displayDirection:"158°",displayGeolocationMechanism:"GPS",displayTimestamp:"2025-01-01 12:10:00",displayConfidence:"400m",displayLatitude:"53.478",displayLongitude:"-2.25"},{latitude:53.483,longitude:-2.236,precision:200,sequenceNumber:3,speed:9,direction:.52,geolocationMechanism:"GPS",timestamp:"2025-01-01T12:20:00Z",overlayTitleTemplateId:"overlay-title-test-location",overlayBodyTemplateId:"overlay-body-test-location",personName:"Jane Doe",personNomisId:"A1234BC",displaySpeed:"9 km/h",displayDirection:"30°",displayGeolocationMechanism:"GPS",displayTimestamp:"2025-01-01 12:20:00",displayConfidence:"200m",displayLatitude:"53.483",displayLongitude:"-2.236"},{latitude:53.476,longitude:-2.229,precision:500,sequenceNumber:4,speed:2,direction:3.14,geolocationMechanism:"GPS",timestamp:"2025-01-01T12:30:00Z",overlayTitleTemplateId:"overlay-title-test-location",overlayBodyTemplateId:"overlay-body-test-location",personName:"Jane Doe",personNomisId:"A1234BC",displaySpeed:"2 km/h",displayDirection:"180°",displayGeolocationMechanism:"GPS",displayTimestamp:"2025-01-01 12:30:00",displayConfidence:"500m",displayLatitude:"53.476",displayLongitude:"-2.229"},{latitude:53.485,longitude:-2.26,precision:300,sequenceNumber:5,speed:4,direction:4.71,geolocationMechanism:"GPS",timestamp:"2025-01-01T12:40:00Z",overlayTitleTemplateId:"overlay-title-test-location",overlayBodyTemplateId:"overlay-body-test-location",personName:"Jane Doe",personNomisId:"A1234BC",displaySpeed:"4 km/h",displayDirection:"270°",displayGeolocationMechanism:"GPS",displayTimestamp:"2025-01-01 12:40:00",displayConfidence:"300m",displayLatitude:"53.485",displayLongitude:"-2.26"},{latitude:53.472,longitude:-2.245,precision:100,sequenceNumber:6,speed:7,direction:5.23,geolocationMechanism:"GPS",timestamp:"2025-01-01T12:50:00Z",overlayTitleTemplateId:"overlay-title-test-location",overlayBodyTemplateId:"overlay-body-test-location",personName:"Jane Doe",personNomisId:"A1234BC",displaySpeed:"7 km/h",displayDirection:"300°",displayGeolocationMechanism:"GPS",displayTimestamp:"2025-01-01 12:50:00",displayConfidence:"100m",displayLatitude:"53.472",displayLongitude:"-2.245"},{latitude:53.49,longitude:-2.255,precision:100,sequenceNumber:7,speed:3,direction:6.28,geolocationMechanism:"GPS",timestamp:"2025-01-01T13:00:00Z",overlayTitleTemplateId:"overlay-title-test-location",overlayBodyTemplateId:"overlay-body-test-location",personName:"Jane Doe",personNomisId:"A1234BC",displaySpeed:"3 km/h",displayDirection:"360°",displayGeolocationMechanism:"GPS",displayTimestamp:"2025-01-01 13:00:00",displayConfidence:"100m",displayLatitude:"53.49",displayLongitude:"-2.255"}];function Ve(){const i="overlay-title-test-location",e="overlay-body-test-location";if(document.getElementById(i)&&document.getElementById(e))return;const t=document.createElement("template");t.id=i,t.innerHTML=`
    <div><strong>Name (NOMIS ID): {{personName}} ({{personNomisId}})</strong></div>
  `.trim();const o=document.createElement("template");o.id=e,o.innerHTML=`
    <div class="app-map__overlay-row"><span class="app-map__overlay-label">Speed </span><span class="app-map__overlay-value">{{displaySpeed}}</span></div>
    <div class="app-map__overlay-row"><span class="app-map__overlay-label">Direction </span><span class="app-map__overlay-value">{{displayDirection}}</span></div>
    <div class="app-map__overlay-row"><span class="app-map__overlay-label">Geolocation Mechanism </span><span class="app-map__overlay-value">{{displayGeolocationMechanism}}</span></div>
    <div class="app-map__overlay-row"><span class="app-map__overlay-label">Recorded </span><span class="app-map__overlay-value">{{displayTimestamp}}</span></div>
    <div class="app-map__overlay-row"><span class="app-map__overlay-label">Confidence </span><span class="app-map__overlay-value">{{displayConfidence}}</span></div>
    <div class="app-map__overlay-row"><span class="app-map__overlay-label">Latitude </span><span class="app-map__overlay-value">{{displayLatitude}}</span></div>
    <div class="app-map__overlay-row"><span class="app-map__overlay-label">Longitude </span><span class="app-map__overlay-value">{{displayLongitude}}</span></div>
  `.trim(),document.body.appendChild(t),document.body.appendChild(o)}function Ke({container:i=document.body,positions:e,renderer:t="openlayers",enable3D:o=!0,controls:s={grabCursor:!0,scale:"bar",locationDisplay:"latlon",rotate:"true",olRotationMode:"default",olRotateTooltip:!0,zoomSlider:!0},showPositions:a=!0,showTracks:l=!1,showText:c=!1,showCircles:n=!1,usesInternalOverlays:p=!0}={}){const r=document.createElement("em-map"),w="iXbItSbCB53tFNL2iP8kwQNmnfkWK0EX",q=`${k.tiles.urls.vectorStyleUrl}${k.tiles.urls.vectorStyleUrl.includes("?")?"&":"?"}key=${w}`;r.setAttribute("api-key",w),r.setAttribute("csp-nonce","1234abcd"),r.setAttribute("vector-test-url",q),p&&(r.setAttribute("uses-internal-overlays",""),Ve()),t==="maplibre"&&r.setAttribute("renderer","maplibre"),o&&r.setAttribute("enable-3d-buildings",""),s.scale&&r.setAttribute("scale-control",s.scale),s.locationDisplay&&r.setAttribute("location-display",s.locationDisplay),s.rotate&&r.setAttribute("rotate-control",s.rotate),s.olRotationMode&&r.setAttribute("ol-rotation-mode",s.olRotationMode),typeof s.olRotateTooltip=="boolean"&&r.setAttribute("ol-rotate-tooltip",String(s.olRotateTooltip)),typeof s.zoomSlider=="boolean"&&r.setAttribute("zoom-slider",String(s.zoomSlider)),typeof s.grabCursor=="boolean"&&r.setAttribute("grab-cursor",String(s.grabCursor));const z=e??Je,f=document.createElement("script");return f.type="application/json",f.slot="position-data",f.textContent=JSON.stringify(z),r.appendChild(f),i.appendChild(r),r.addEventListener("map:ready",()=>{const y=r,b=y.olMapInstance,u=y.positions;if(!b||!u?.length)return;const J=y.addLayer(new ue({title:"pointsLayer",positions:u,visible:a}));y.addLayer(new Ge({title:"tracksLayer",positions:u,visible:l})),y.addLayer(new ze({positions:u,textProperty:"sequenceNumber",title:"textLayer",visible:c})),y.addLayer(new Ce({positions:u,id:"confidence",title:"confidenceLayer",visible:n}));const D=J?.getSource();if(D){const A=D.getExtent();ae(A)===!1&&b.getView().fit(A,{maxZoom:16,padding:[30,30,30,30],size:b.getSize()})}}),r}export{Je as p,Ke as s};
